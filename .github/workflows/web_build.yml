name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.51

      # PASO MAGICO: Creamos la receta CMake en el servidor
      # Esto asegura que GitHub compile EXACTAMENTE igual que tu CLion
      - name: Generar CMakeLists.txt
        run: |
          cat <<EOF > CMakeLists.txt
          cmake_minimum_required(VERSION 3.11)
          project(AsteroidsWeb)
          set(CMAKE_CXX_STANDARD 17)

          # 1. Descargar Raylib 5.5 (La versión que te funcionó)
          include(FetchContent)
          FetchContent_Declare(
            raylib
            GIT_REPOSITORY https://github.com/raysan5/raylib.git
            GIT_TAG 5.5
          )
          FetchContent_MakeAvailable(raylib)

          # 2. Configurar tu juego
          add_executable(index main.cpp)
          target_link_libraries(index raylib)

          # 3. Configurar la Web (HTML5)
          # Esto le dice a CMake que el resultado debe ser un .html
          set_target_properties(index PROPERTIES SUFFIX ".html")
          
          # Estas son las banderas vitales para que no se congele el navegador
          target_link_options(index PRIVATE 
            "-sUSE_GLFW=3" 
            "-sASYNCIFY" 
            "-sALLOW_MEMORY_GROWTH=1" 
            "-sFORCE_FILESYSTEM=1"
            "--shell-file=\${CMAKE_CURRENT_SOURCE_DIR}/shell.html"
          )
          EOF

      - name: Compilar (Usando CMake)
        run: |
          # 'emcmake' configura el proyecto para WebAssembly
          emcmake cmake -S . -B build -DPLATFORM=Web -DGRAPHICS=GRAPHICS_API_OPENGL_ES2
          
          # Construimos el proyecto (esto tardará unos minutos la primera vez)
          cmake --build build

      - name: Preparar archivos para subir
        run: |
          # Movemos los archivos generados a la carpeta principal
          cp build/index.html .
          cp build/index.js .
          cp build/index.wasm .

      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

  deploy:
    needs: build
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
